<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <meta charset="utf-8">

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>

    div.tooltip {
            position: absolute;
            text-align: center;
            width: 130px;
            height: 70px;
            padding: 2px;
            font: 12px sans-serif;
            background: white;
            border: 0px;
            border-radius: 0px;
            pointer-events: none;
        }

    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .stations, .stations svg {
      position: absolute;
    }

    .stations svg {
      width: 60px;
      height: 20px;
      padding-right: 100px;
      font: 10px sans-serif;
    }

    .stations circle {
      fill: brown;
      stroke: black;
      stroke-width: 1.5px;
    }


    #topRow {
      margin-top: 100px;
      text-align: center;
    }

    #topRow h1 {
      font-size: 300%;
    }

    .bold {
      font-weight: bold;
    }

    .marginTop {
      margin-top: 30px;
    }
    .center {
      text-align: center;
    }

    .white {
        color: #fff;
    }
    .title {
      margin-top: 100px;
      font-size: 300%;
    }
    .calendarIcon {
        margin-top: 14px;
    }
    .glyphicon {
        font-size: 20px;
    }

    #footer {
      background-color: #B0D1FB;
      width: 100%
    }

    .marginBottom {
      margin-bottom: 30px;

    }

    .appstoreImage  {
      width:250px;
    }

    #graph {
    width: 1200px;
    height: 500px;
    }

    .tick line {
        stroke-dasharray: 2 2 ;
        stroke: #000000;
    }

    //vis5
    .node--library circle {
      fill: #FFF68F;
    }

    .node--school circle {
      fill: #D1EEEE;
    }

    .node--shooting circle {
      fill: #000000;
    }

    .node text {
      font: 10px sans serif;
    }

    .node--internal circle {
      fill: #555;
    }

    .node--internal text {
      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
    }

    .link {
      fill: none;
      stroke: #555;
      stroke-opacity: 0.4;
      stroke-width: 1.5px;
    }

    </style>
</head>
<script src="//maps.google.com/maps/api/js?key=AIzaSyDaUerSk9PITzfXHom6TvRStBETRQwa9Pw"></script>
<script src="//d3js.org/d3.v4.min.js"></script>

<body data-spy="scroll" data-target=".navbar-collapse">

<div class="navbar navbar-inverse navbar-fixed-top">
  
      <div class="container">
      
        <div class="navbar-header">
        
            <a href="" class="navbar-brand">Project 3</a>

            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            
          <span class="sr-only">Toggle navigation</span>

          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
            
            </button>
        
        </div>

        <div class="collapse navbar-collapse">

            <ul class="nav navbar-nav">
          
                <li><a href="#vis1">First Challenge</a></li>
                  
                <li><a href="#vis2">Second Challenge</a></li>


            </ul>


            <form class="navbar-form navbar-right">
                <div class="form-group navbar-right">
                        <select class="form-control" data-show-icon="true" id="selectDay" >
                            <option value="trip_leg_matrix_2014_04_01_DDP.csv">2014/04/01_Tu</option>
                            <option value="trip_leg_matrix_2014_04_02_DDP.csv">2014/04/02_We</option>
                            <option value="trip_leg_matrix_2014_04_03_DDP.csv">2014/04/03_Th</option>
                            <option value="trip_leg_matrix_2014_04_04_DDP.csv">2014/04/04_Fr</option>
                            <option value="trip_leg_matrix_2014_04_05_DDP.csv">2014/04/05_Sa</option>
                            <option value="trip_leg_matrix_2014_04_06_DDP.csv">2014/04/06_Su</option>
                            <option value="trip_leg_matrix_2014_04_07_DDP.csv">2014/04/07_Mo</option>
                            <option value="trip_leg_matrix_2014_04_08_DDP.csv">2014/04/08_Tu</option>
                            <option value="trip_leg_matrix_2014_04_09_DDP.csv">2014/04/09_We</option>
                            <option value="trip_leg_matrix_2014_04_10_DDP.csv">2014/04/10_Th</option>
                            <option value="trip_leg_matrix_2014_04_11_DDP.csv">2014/04/11_Fr</option>
                            <option value="trip_leg_matrix_2014_04_12_DDP.csv">2014/04/12_Sa</option>
                            <option value="trip_leg_matrix_2014_04_13_DDP.csv">2014/04/13_Su</option>
                            <option value="trip_leg_matrix_2014_04_14_DDP.csv">2014/04/14_Mo</option>
                            <option value="trip_leg_matrix_2014_04_15_DDP.csv">2014/04/15_Tu</option>
                            <option value="trip_leg_matrix_2014_04_16_DDP.csv">2014/04/16_We</option>
                            <option value="trip_leg_matrix_2014_04_17_DDP.csv">2014/04/17_Th</option>
                            <option value="trip_leg_matrix_2014_04_18_DDP.csv">2014/04/18_Fr</option>
                            <option value="trip_leg_matrix_2014_04_19_DDP.csv">2014/04/19_Sa</option>
                            <option value="trip_leg_matrix_2014_04_20_DDP.csv">2014/04/20_Su</option>
                            <option value="trip_leg_matrix_2014_04_21_DDP.csv">2014/04/21_Mo</option>
                            <option value="trip_leg_matrix_2014_04_22_DDP.csv">2014/04/22_Tu</option>
                            <option value="trip_leg_matrix_2014_04_23_DDP.csv">2014/04/23_We</option>
                            <option value="trip_leg_matrix_2014_04_24_DDP.csv">2014/04/24_Th</option>
                            <option value="trip_leg_matrix_2014_04_25_DDP.csv">2014/04/25_Fr</option>
                            <option value="trip_leg_matrix_2014_04_26_DDP.csv">2014/04/26_Sa</option>
                            <option value="trip_leg_matrix_2014_04_27_DDP.csv">2014/04/27_Su</option>
                            <option value="trip_leg_matrix_2014_04_28_DDP.csv">2014/04/28_Mo</option>
                            <option value="trip_leg_matrix_2014_04_29_DDP.csv">2014/04/29_Tu</option>
                            <option value="trip_leg_matrix_2014_04_30_DDP.csv">2014/04/30_We</option>
                        </select>
                </div>

                <div class="form-group navbar-right">
                        <select class="form-control" data-show-icon="true" id="selectTime" >
                            <option value='morning'>Morning</option>
                            <option value='noon'>Noon</option>
                            <option value='afternoon'>Afternoon</option>
                            <option value='evening'>Evening</option>
                            <option value='night'>Night</option>
                            <option value='midnight'>Midnight</option>
                            <option value='latenight'>Late Night</option>
                            <option value='all'>-ALL-</option>
                        </select>
                </div>

                <div class="form-group navbar-right">
                        <select class="form-control" data-show-icon="true" id="selectType" >
                            <option value="HW">Home to Work</option>
                            <option value="WH">Work to Home</option>
                            <option value="HO">Home to Other</option>
                            <option value="OH">Other to Home</option>
                            <option value="OW">Other to Work</option>
                            <option value="WO">Work to Other</option>
                            <option value="HH">Home to Home</option>
                            <option value="OO">Other to Other</option>
                            <option value="WW">Work to Work</option>
                            <option value="all">-All-</option>
                        </select>
                </div>


            </form>

            <form class="navbar-form navbar-right white calendarIcon">
                <div><span class="glyphicon glyphicon-calendar navbar-right"></span></div>
            </form>


        </div>


      </div> 
  
</div> 



<div class="container marginTop" id="vis1">
</div>


<script>

var width = 1400;
var height = 1200;

var projection = d3.geoAlbers()
        .translate([width/2, height/2])
        .scale([88000])
        .rotate([81.37923649999999,0])
        .center([0,28.5383355]);

    //Define path generator
    var path = d3.geoPath()
      .projection(projection);

var svg = d3.select("body")
  .append("svg")
  .attr("width", width)
  .attr("height", height)

// Append Div for tooltip to SVG
    var div = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

var g = svg.append("g");

var tripType = {
  HW : ["HW"],
  WH : ["WH"],
  HO : ["HO"],
  OH : ["OH"],
  OW : ["OW"],
  WO : ["WO"],
  HH : ["HH"],
  OO : ["OO"],
  WW : ["WW"],
  all : ["HW","WH","HO","OH","OW","WO","HH","WW","OO"]
}

var times = {

  morning : ["H04:H05","H05:H06","H06:H07","H07:H08","H08:H09","H09:H10","H10:H11","H11:H12"],
  noon : ["H12:H13"],
  afternoon : ["H13:H14","H14:H15","H15:H16","H16:H17","H17:H18"],
  evening : ["H18:H19","H19:H20","H20:H21"],
  night : ["H21:H22","H22:H23","H23:H24"],
  midnight : ["H24:H01"],
  latenight : ["H01:H02","H02:H03","H03:H04"],
  all : ["H04:H05", "H05:H06", "H06:H07", "H07:H08", "H08:H09", "H09:H10", "H10:H11", "H11:H12", "H12:H13", "H13:H14", "H14:H15", "H15:H16", "H16:H17", "H17:H18", "H18:H19", "H19:H20", "H20:H21", "H21:H22", "H22:H23", "H23:H24"]
}

function contains(array, search) {
  for (var i = 0; i < array.length; i++) {
    if (array[i] === search) {
      return true;
    }
  }
  return false;
}

d3.json("archive.zip.geojson", function(error, data) {

  var pathing = g.selectAll("path")
    .data(data.features)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("count", 0)
    .attr("incoming", 0)
    .attr("outgoing", 0)
    // adding an id attribute so I can select paths by thier id, requires an underscore at the beginning for some reason 
    .attr("id", function (d) {
      return "_" + d.properties.TAZ_ID; 
    })
    .style("fill", "grey")
    .style("stroke", "#fff")
    .style("stroke-width", "1")
    .on("click", function (d) {

      // initializing to 0
      d3.selectAll("path").attr("count", 0)
      d3.selectAll("path").attr("incoming", 0)
      d3.selectAll("path").attr("outgoing", 0)

      // coordinates of center of clicked zone
      var centroid = path.centroid(d);
      var x = centroid[0]
      var y = centroid[1]

      svg.selectAll("line").remove()
      d3.selectAll("path").style("fill", "grey").style("stroke", "#fff").style("stroke-width", "1")

      // get selected day
      var dropdownDay = document.getElementById("selectDay");
      var usrDay = dropdownDay.options[dropdownDay.selectedIndex].value;
      var areaId = d.properties.TAZ_ID

      d3.csv(usrDay, function (csvdata) {

        // getting max and min count for zone selected to set approriate color scale
        var maxCount=0;
        var minCount=0;

        // get selected trip type
        var dropdownType = document.getElementById("selectType");
        var typeIndex = dropdownType.options[dropdownType.selectedIndex].value;
        var usrType = tripType[typeIndex]

        // get selected time of day
        var dropdownTime = document.getElementById("selectTime");
        var timesIndex = dropdownTime.options[dropdownTime.selectedIndex].value;
        var usrTime = times[timesIndex]

        // search entire file for trips matching selected type+time+day
        for (var i=0; i < csvdata.length; i++) {
          //trips originating from clicked zone, does not include trips that start and end in same zone
          if (csvdata[i].Origin_Zone == areaId && contains(usrType, csvdata[i].Purpose) && csvdata[i].Destination_Zone != areaId && contains(usrTime, csvdata[i].Time_of_Day)) {

            // incoming here means # of trips from zone clicked to colored zone
            var pathCount = d3.select("path#_"+csvdata[i].Destination_Zone).attr("incoming")
            var newCount = parseInt(pathCount) + parseInt(csvdata[i].Count)
            if (newCount > maxCount) { maxCount = newCount}
            if (newCount < minCount) { minCount = newCount}
            // updates incoming count as it reads entire file
            d3.select("path#_"+csvdata[i].Destination_Zone)
              .attr("incoming", newCount)
          }

          // trips originating from outside zones to clicked zone, also skips trips that start and end in same zone 
          if (csvdata[i].Origin_Zone != areaId && contains(usrType, csvdata[i].Purpose) && csvdata[i].Destination_Zone == areaId && contains(usrTime, csvdata[i].Time_of_Day)) {

            // outgoing here means # of trips from colored zone to clicked zone
            var pathCount = d3.select("path#_"+csvdata[i].Destination_Zone).attr("outgoing")
            var newCount = parseInt(pathCount) + parseInt(csvdata[i].Count)
            if (newCount > maxCount) { maxCount = newCount}
            if (newCount < minCount) { minCount = newCount}
            d3.select("path#_"+csvdata[i].Origin_Zone)
              .attr("outgoing", newCount)
          }
        }

        // scale domain is calculated for current clicked zone, one 
        var color = d3.scaleQuantize()
            .domain([minCount,maxCount])
            .range(["#ffb2b2","#ff9999","#ff7f7f","#ff6666","#ff4c4c","#ff3232","ff1919","ff0000","#e50000"]);

        var color2 = d3.scaleQuantize()
            .domain([minCount,maxCount])
            .range(["#b3d9ff","#80bfff","#3399ff","#0080ff","#0066cc","#004d99","#004080","#003366","#001a33"]);

        d3.selectAll("path").each(function (d, i) { 
        // filling zones that contains trips involving clicked zone
          if (d3.select("path#_"+csvdata[i].Destination_Zone).attr("outgoing") > 0 || d3.select("path#_"+csvdata[i].Destination_Zone).attr("incoming") > 0){
            if (parseInt(d3.select("path#_"+csvdata[i].Destination_Zone).attr("incoming")) >= parseInt(d3.select("path#_"+csvdata[i].Destination_Zone).attr("outgoing"))) {
              d3.select("path#_"+csvdata[i].Destination_Zone)
                .attr("destination", 1)
                .style("fill", function (d) {
                  return color(d3.select("path#_"+csvdata[i].Destination_Zone).attr("incoming"));
                })

              // setting coordinates to center of destination zone, so line can be drawn
              var centroidTmp = path.centroid(d3.select("path#_"+csvdata[i].Destination_Zone).datum())
              var x2 = centroidTmp[0]
              var y2 = centroidTmp[1]
              g.append("line")
                        .style("stroke", "#e50000")
                        .style("stroke-width", "1")
                        .attr("x1", x)
                        .attr("y1", y)
                        .attr("x2", x)
                        .attr("y2", y)
                        .transition()
                        .duration(5000)
                        .attr("x2", x2)
                        .attr("y2", y2);
            } else {
              d3.select("path#_"+csvdata[i].Destination_Zone)
                .attr("destination", 1)
                .style("fill", function (d) {
                  return color2(d3.select("path#_"+csvdata[i].Destination_Zone).attr("outgoing"));
                })
              // setting coordinates to center of destination zone, so line can be drawn
              var centroidTmp = path.centroid(d3.select("path#_"+csvdata[i].Destination_Zone).datum())
              var x2 = centroidTmp[0]
              var y2 = centroidTmp[1]
              g.append("line")
                        .style("stroke", "#004080")
                        .style("stroke-width", "1")
                        .attr("x1", x)
                        .attr("y1", y)
                        .attr("x2", x)
                        .attr("y2", y)
                        .transition()
                        .duration(5000)
                        .attr("x2", x2)
                        .attr("y2", y2);
            }
          }
        });
      });
    })
    // mouseover tooltip
    .on("mouseover", function (d) {
      if (d3.select(this).attr("count")) {
        d3.select(this)
          div.transition()
              .duration(200)
              .style("opacity", .9);
          div.html("County: " + d.properties.COUNTY + "</br>" + " Zone: " + d.properties.TAZ_ID + "</br>" + " Incoming: " + d3.select(this).attr("incoming") + 
            "</br>" + " Outgoing: " + d3.select(this).attr("outgoing"))
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
      } else {
        d3.select(this)
          div.transition()
              .duration(200)
              .style("opacity", .9);
          div.html("County: " + d.properties.COUNTY + "</br>" + " Zone: " + d.properties.TAZ_ID)
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
      }
    })
    .call(d3.zoom().on("zoom", function() {
      g.attr("transform", d3.event.transform)
    }))

});

</script>
</body>