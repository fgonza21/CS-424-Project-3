<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<style>

div.tooltip {
        position: absolute;
        text-align: center;
        width: 100px;
        height: 60px;
        padding: 2px;
        font: 12px sans-serif;
        background: white;
        border: 0px;
        border-radius: 0px;
        pointer-events: none;
    }

html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.stations, .stations svg {
  position: absolute;
}

.stations svg {
  width: 60px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations circle {
  fill: brown;
  stroke: black;
  stroke-width: 1.5px;
}

</style>
<div id="map"></div>
<script src="//maps.google.com/maps/api/js?key=AIzaSyDaUerSk9PITzfXHom6TvRStBETRQwa9Pw"></script>
<script src="//d3js.org/d3.v4.min.js"></script>
<script>

var width = 1400;
var height = 1200;

var projection = d3.geoAlbers()
        .translate([width/2, height/2])
        .scale([88000])
        .rotate([81.37923649999999,0])
        .center([0,28.5383355]);

    //Define path generator
    var path = d3.geoPath()
      .projection(projection);

var svg = d3.select("body")
  .append("svg")
  .attr("width", width)
  .attr("height", height)

// Append Div for tooltip to SVG
    var div = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

var g = svg.append("g");

// Load the station data. When the data comes back, create an overlay.
d3.json("archive.zip.geojson", function(error, data) {


  var pathing = g.selectAll("path")
    .data(data.features)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("id", function (d) {
      return "_" + d.properties.TAZ_ID; 
    })
    .style("fill", "#240f3f")
    .style("stroke", "#fff")
    .style("stroke-width", "1")
    //.style("fill-opacity","0.7")
    .on("click", function (d) {

      var centroid = path.centroid(d);
      var x = centroid[0]
      var y = centroid[1]

      svg.selectAll("line").remove()
      d3.selectAll("path").style("fill", "#240f3f").style("stroke", "#fff").style("stroke-width", "1")
      console.log(pathing.attr('id'))
      var areaId = d.properties.TAZ_ID
      d3.csv("trips.csv", function (csvdata) {

        // getting max and min count for zone selected to set approriate color scale
        var maxCount=0;
        var minCount=0;
        //var colorDomain[];
        for (var i=0; i < csvdata.length; i++) {
          if (csvdata[i].Origin_Zone == areaId && csvdata[i].Purpose == "HO" && csvdata[i].Destination_Zone != areaId) {
            console.log(csvdata[i].Count)
            //colorDomain[i] = csvdata[i].Count
            if (csvdata[i].Count > maxCount) { maxCount = csvdata[i].Count}
            if (csvdata[i].Count < minCount) { minCount = csvdata[i].Count}
            d3.select("path#_"+csvdata[i].Destination_Zone)
              .attr("count", csvdata[i].Count)
          }
        }

        // scale domain is calculated for current zone
        var color = d3.scaleQuantize()
            .domain([minCount,maxCount])
            .range(["#ffb2b2","#ff9999","#ff7f7f","#ff6666","#ff4c4c","#ff3232","ff1919","ff0000","#e50000"]);

        // filling zones that are visited from selected zone
        console.log(csvdata[0]);
        for (var i=0; i < csvdata.length; i++) {
          if (csvdata[i].Origin_Zone == areaId && csvdata[i].Purpose == "HO" && csvdata[i].Destination_Zone != areaId) {
            console.log(csvdata[i].Count)
            d3.select("path#_"+csvdata[i].Destination_Zone)
              .attr("destination", 1)
              .style("fill", function (d) {
                return color(parseInt(csvdata[i].Count));
              })
            var centroidTmp = path.centroid(d3.select("path#_"+csvdata[i].Destination_Zone).datum())
            var x2 = centroidTmp[0]
            var y2 = centroidTmp[1]
            //console.log("x2: " + centroidTmp[0] + "  y2: " + centroidTmp[1]) 
            g.append("line")
                      .style("stroke", "#ff7f7f")
                      .style("stroke-width", "1")
                      .attr("x1", x)
                      .attr("y1", y)
                      .attr("x2", x2)
                      .attr("y2", y2);
          }
          
        }
      });
      var centroid = path.centroid(d);
      //console.log('Centroid at: ', d,+ centroid[0] + ', ' + centroid[1]);
      //svg.attr("class", "line")
                      //svg.selectAll("line")
                      //.enter().append("line")
                      svg.append("line")
                      .style("stroke", "black")
                      .style("stroke-width", "4")
                      .attr("x1", 212.2470572092787)
                      .attr("y1", 1614.8729895044553)
                      .attr("x2", -365.2988043384223)
                      .attr("y2", 309.721393419856);
    })
    .on("mouseover", function (d) {
      if (d3.select(this).attr("count")) {
        d3.select(this)
          div.transition()
              .duration(200)
              .style("opacity", .9);
          div.html("County: " + d.properties.COUNTY + "</br>" + " Zone: " + d.properties.TAZ_ID + " Count: " + "</br>" + d3.select(this).attr("count"))
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
      } else {
        d3.select(this)
          div.transition()
              .duration(200)
              .style("opacity", .9);
          div.html("County: " + d.properties.COUNTY + "</br>" + " Zone: " + d.properties.TAZ_ID)
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
      }
    })
    /*.on("mouseout", function(data) {
                    d3.select(this)
                    .style("fill", "steelblue");
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
    }) */
    .call(d3.zoom().on("zoom", function() {
      g.attr("transform", d3.event.transform)
    }))

                        
});

</script>